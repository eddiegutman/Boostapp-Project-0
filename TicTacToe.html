<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicTacToe</title>

    <style>
        td {
            height: 100px;
            width: 100px;
        }

        img {
            height: 100px;
            width: 100px;
            visibility: hidden;
        }
    </style>
</head>

<body>
    <table border="1">
        <tr>
            <td onclick="move(`img0`)"><img id="img0" src="0"></td>
            <td onclick="move(`img1`)"><img id="img1" src="1"></td>
            <td onclick="move(`img2`)"><img id="img2" src="2"></td>
        </tr>
        <tr>
            <td onclick="move(`img3`)"><img id="img3" src="3"></td>
            <td onclick="move(`img4`)"><img id="img4" src="4"></td>
            <td onclick="move(`img5`)"><img id="img5" src="5"></td>
        </tr>
        <tr>
            <td onclick="move(`img6`)"><img id="img6" src="6"></td>
            <td onclick="move(`img7`)"><img id="img7" src="7"></td>
            <td onclick="move(`img8`)"><img id="img8" src="8"></td>
        </tr>
    </table> <br>
    <input type="button" value="New Game" onclick="newGame()">
    <input type="button" value="Undo" onclick="undo()">
    <input type="button" value="Score">
    <input type="button" value="Save">
    <input type="button" value="Load">
    <input type="button" value="Mode">

    <script>

        class Board {
            constructor(size) {
                const table = [];
                for (let i = 0; i < size; i++) {
                    const row = [];
                    for (let j = 0; j < size; j++) {
                        row.push(document.getElementById(`img${i * size + j}`));
                    }
                    table.push(row);
                }

                this.size = size;
                this.table = table;
            }

            // getImgObj(imgNum) {
            //     const i = parseInt(imgNum / this.size);
            //     const j = imgNum % this.size;
            //     return this.table[i][j];
            // }

            checkRow(n) {
                let flag = true;
                for (let i = 0; i < this.size - 1; i++) {
                    if (this.table[n][i].src != this.table[n][i + 1].src) {
                        flag = false;
                        break;
                    }
                }
                return flag;
            }

            checkCol(n) {
                let flag = true;
                for (let i = 0; i < this.size - 1; i++) {
                    if (this.table[i][n].src != this.table[i + 1][n].src) {
                        flag = false;
                        break;
                    }
                }
                return flag;
            }

            checkDiag1() {
                let flag = true;
                for (let i = 0; i < this.size - 1; i++) {
                    if (this.table[i][i].src != this.table[i + 1][i + 1].src) {
                        flag = false;
                        break;
                    }
                }
                return flag;
            }

            checkDiag2() {
                let flag = true;
                for (let i = 0; i < this.size - 1; i++) {
                    if (this.table[i][this.size - (i + 1)].src != this.table[i + 1][this.size - (i + 2)].src) {
                        flag = false;
                        break;
                    }
                }
                return flag;
            }

            checkWin() {
                if (this.checkDiag1()) {
                    return true;
                } else if (this.checkDiag2()) {
                    return true;
                }
                for (let i = 0; i < this.size; i++) {
                    if (this.checkRow(i)) {
                        return true;
                    } else if (this.checkCol(i)) {
                        return true;
                    }
                }
                return false;
            }

            resetBoard() {
                for (let i = 0; i < this.size; i++) {
                    for (let j = 0; j < this.size; j++) {
                        this.table[i][j].src = `${i * this.size + j}`;
                        this.table[i][j].style.visibility = "hidden";
                    }
                }
            }

            // saveBoardState() {
            //     let str = "";
            //     for (let i = 0; i < this.size; i++) {
            //         for (let j = 0; j < this.size; j++) {
            //             str += `${this.table[i][j].src}`;
            //             str += `,`;
            //         }
            //     }
            //     return str;
            // }

            // loadBoardState(state) {
            //     const arr = state.split(`,`);
            //     for (let i = 0; i < this.size; i++) {
            //         for (let j = 0; j < this.size; j++) {
            //             this.table[i][j].src = arr[(i * this.size) + j];
            //             if (this.table[i][j].src != `./x.png` && this.table[i][j].src != `./o.png`) {
            //                 this.table[i][j].style.visibility = "hidden";
            //             }
            //         }
            //     }
            // }
        }

        class Game {
            constructor(size) {
                this.isCircle = false;
                this.gameOver = false;
                this.board = new Board(size);
                this.history = [];
            }

            // move(imgNum) {
            //     const imgObj = this.board.getImgObj(imgNum);
            //     if (window.getComputedStyle(imgObj).visibility == "hidden" && !this.gameOver) {
            //         imgObj.src = `./${this.currentPlayer()}.png`;
            //         imgObj.style.visibility = "visible";
            //     }
            // }

            currentPlayer() {
                return this.isCircle ? "o" : "x";
            }

            switchPlayer() {
                this.isCircle = !this.isCircle;
            }

            checkWin() {
                if (this.board.checkWin()) {
                    this.gameOver = true;
                    return true;
                } else {
                    return false;
                }
            }

            newGame() {
                this.board.resetBoard();
                this.isCircle = false;
                this.gameOver = false;
            }

            saveLastMove(imgID) {
                this.history.push(`${imgID}`);
            }

            loadLastMove() {
                const imgID = this.history.pop();
                //this.board.loadBoardState(str);
                const imgObj = document.getElementById(imgID);
                imgObj.src = `${imgID.slice(3)}`;
                imgObj.style.visibility = "hidden";
            }
        }


        const game = new Game(3);


        function move(imgID) {
            const imgObj = document.getElementById(imgID);
            const player = game.currentPlayer();
            if (window.getComputedStyle(imgObj).visibility == "hidden" && !game.gameOver) {
                game.saveLastMove(imgID);
                imgObj.src = `./${player}.png`;
                imgObj.style.visibility = "visible";
                if (game.checkWin()) {
                    window.setTimeout(function () { alert(`${player} is the winner!`) });
                }
                game.switchPlayer();
            }

            // game.move(imgNum)
            // if (game.checkGameOver()) {
            //     window.setTimeout(function () { alert(`${player} is the winner!`) }, 5);
            // }
            // game.switchPlayer();
        }

        function newGame() {
            game.newGame();
        }

        function undo() {
            if (game.history.length > 0 && !game.gameOver) {
                game.loadLastMove();
                game.switchPlayer();
            } else {
                alert("Cannot undo anymore");
            }
        }

    </script>
</body>

</html>